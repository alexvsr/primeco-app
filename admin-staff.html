<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion du Staff - Prime&Co Admin</title>
    <meta name="description" content="Gestion du staffing par événement et buvette">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="shared.css">
    <style>
        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* Grenat bar */
        .grenat-bar {
            height: 4px;
            background: linear-gradient(90deg, #601D2B, #C9A227);
            flex-shrink: 0;
        }

        /* Header */
        .header-bar {
            background: white;
            padding: 12px 24px;
            flex-shrink: 0;
        }

        .brand-logo {
            height: 36px;
        }

        /* Main layout */
        .main-wrapper {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 340px;
            background: white;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 4px;
        }

        .sidebar-subtitle {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .search-box {
            margin: 16px 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 16px 12px 40px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
        }

        .staff-pool {
            flex: 1;
            overflow-y: auto;
            padding: 0 20px 20px;
        }

        .staff-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 12px 16px;
            margin-bottom: 8px;
            cursor: grab;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
            box-shadow: var(--shadow-sm);
        }

        .staff-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(96, 29, 43, 0.1);
        }

        .staff-card:active {
            cursor: grabbing;
        }

        .staff-card.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }

        .staff-card.assigned {
            opacity: 0.5;
            cursor: not-allowed;
            background: var(--bg-tertiary);
            border-color: transparent;
        }

        .staff-card.assigned:hover {
            border-color: transparent;
            box-shadow: none;
        }

        .arrival-time {
            background: var(--primary);
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 6px;
            margin-right: 8px;
        }

        .arrival-time.editable {
            cursor: pointer;
            transition: all 0.2s;
        }

        .arrival-time.editable:hover {
            background: var(--secondary);
            transform: scale(1.05);
        }

        .staff-info .name {
            font-weight: 600;
            color: var(--text);
        }

        .staff-info .type {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .sidebar-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
        }

        /* Content */
        .content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            background: var(--bg-primary);
        }

        /* Event selector */
        .event-selector {
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: var(--shadow-sm);
        }

        .event-selector label {
            font-weight: 600;
            color: var(--text);
            margin: 0;
        }

        .event-selector select {
            flex: 1;
            max-width: 400px;
        }

        /* Buvettes grid */
        .buvettes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .buvette-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .buvette-header {
            padding: 16px 20px;
            background: linear-gradient(135deg, rgba(96, 29, 43, 0.05), rgba(201, 162, 39, 0.05));
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .buvette-name {
            font-weight: 600;
            color: var(--text);
        }

        .staff-count {
            font-size: 0.8rem;
            padding: 4px 10px;
            background: var(--primary);
            color: white;
            border-radius: 20px;
        }

        .buvette-body {
            min-height: 120px;
            padding: 16px;
            transition: all 0.2s;
        }

        .buvette-body.drag-over {
            background: rgba(96, 29, 43, 0.05);
            border: 2px dashed var(--primary);
            margin: -1px;
        }

        .buvette-body .staff-card {
            cursor: default;
        }

        .buvette-body .staff-card .remove-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: rgba(220, 38, 38, 0.1);
            color: var(--danger);
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 1;
            transition: all 0.2s;
        }

        .buvette-body .staff-card .remove-btn:hover {
            background: var(--danger);
            color: white;
        }

        .empty-buvette {
            text-align: center;
            color: var(--text-muted);
            padding: 30px;
            font-size: 0.9rem;
        }

        .empty-buvette svg {
            width: 40px;
            height: 40px;
            stroke: var(--border-light);
            margin-bottom: 10px;
        }

        /* Empty grid state */
        .empty-grid {
            grid-column: 1 / -1;
            text-align: center;
            padding: 60px 40px;
            color: var(--text-muted);
        }

        .empty-grid-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            background: var(--bg-tertiary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .empty-grid-icon svg {
            width: 32px;
            height: 32px;
            stroke: var(--text-muted);
        }
    </style>
</head>

<body>
    <!-- Grenat bar -->
    <div class="grenat-bar"></div>

    <!-- Header -->
    <header class="header-bar">
        <div class="brand flex items-center gap-3">
            <img src="primeco_branding_2550x1440_logo_1-1500x847.jpg" alt="Prime&Co" class="brand-logo">
            <span style="color: var(--text-muted); font-size: 0.9rem;">Administration · Staffing</span>
        </div>
        <a href="admin.html" class="btn btn-ghost" style="padding: 8px 14px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                style="width: 18px; height: 18px;">
                <path d="m15 18-6-6 6-6" />
            </svg>
            Retour
        </a>
    </header>

    <div class="main-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2 class="sidebar-title">Staff Disponible</h2>
                <p class="sidebar-subtitle">Glissez vers les buvettes</p>
            </div>
            <div class="search-box">
                <input type="text" placeholder="Rechercher..." onkeyup="filterStaff(this.value)">
            </div>
            <div id="staff-pool" class="staff-pool">
                <div style="text-align: center; color: var(--text-muted); padding: 20px;">
                    Sélectionnez un événement...
                </div>
            </div>
            <div class="sidebar-footer">
                <a href="admin-staff-management.html" class="btn btn-primary" style="width: 100%;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        style="width: 18px; height: 18px;">
                        <path d="M12 5v14M5 12h14" />
                    </svg>
                    Nouveau Staff
                </a>
            </div>
        </aside>

        <!-- Content -->
        <main class="content">
            <div class="event-selector">
                <label for="event-select">Événement :</label>
                <select id="event-select">
                    <option value="">Chargement...</option>
                </select>
            </div>

            <div id="buvettes-grid" class="buvettes-grid">
                <div class="empty-grid">
                    <div class="empty-grid-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                            <rect width="18" height="18" x="3" y="4" rx="2" />
                            <line x1="16" x2="16" y1="2" y2="6" />
                            <line x1="8" x2="8" y1="2" y2="6" />
                            <line x1="3" x2="21" y1="10" y2="10" />
                        </svg>
                    </div>
                    <p><strong>Sélectionnez un événement</strong></p>
                    <p style="margin-top: 8px;">Choisissez un événement pour commencer le staffing</p>
                </div>
            </div>
        </main>
    </div>

    <script src="config.js"></script>
    <script src="shared.js"></script>
    <script>
        const token = localStorage.getItem("access_token");
        if (!token) window.location.href = "index.html";

        let currentEvent = null;
        let allStaff = [];
        let allBuvettes = [];
        let assignments = [];

        // --- Drag & Drop Handlers ---
        function handleDragStart(e) {
            // Find the staff-card element (might be the target or a parent)
            const card = e.target.closest('.staff-card');
            const id = card ? card.dataset.id : e.target.dataset.id;
            console.log("DragStart - ID from card:", id);
            e.dataTransfer.setData("text/plain", id);
            e.target.classList.add("dragging");
        }

        function handleDragEnd(e) {
            e.target.classList.remove("dragging");
            document.querySelectorAll(".buvette-body").forEach(el => el.classList.remove("drag-over"));
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add("drag-over");
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove("drag-over");
        }

        async function handleDrop(e, buvetteId) {
            e.preventDefault();
            let staffId = e.dataTransfer.getData("text/plain");
            e.currentTarget.classList.remove("drag-over");

            // Handle if staffId has a prefix like "staff_"
            if (staffId && staffId.startsWith("staff_")) {
                staffId = staffId.replace("staff_", "");
            }

            console.log("Drop event - staffId:", staffId, "buvetteId:", buvetteId);

            if (staffId && staffId !== "" && !isNaN(parseInt(staffId))) {
                await assignStaff(buvetteId, parseInt(staffId));
            } else {
                console.error("Invalid staffId:", staffId);
                showToast("Erreur: ID du staff invalide", "error");
            }
        }

        // --- Data Loading ---
        async function loadEvents() {
            try {
                const res = await fetch(`${API_URL}/events`, { headers: { "Authorization": `Bearer ${token}` } });
                const events = await res.json();

                const select = document.getElementById("event-select");
                select.innerHTML = '<option value="">-- Choisir un événement --</option>' +
                    events.map(e => {
                        const date = new Date(e.date).toLocaleDateString('fr-CH');
                        return `<option value="${e.id}">${e.name} (${date})</option>`;
                    }).join('');

                select.addEventListener("change", (e) => {
                    if (e.target.value) {
                        currentEvent = e.target.value;
                        loadData();
                    }
                });
            } catch (err) { console.error(err); }
        }

        async function loadData() {
            try {
                const [staffRes, buvettesRes, assignmentsRes] = await Promise.all([
                    fetch(`${API_URL}/staff`, { headers: { "Authorization": `Bearer ${token}` } }),
                    fetch(`${API_URL}/events/${currentEvent}/buvettes`, { headers: { "Authorization": `Bearer ${token}` } }),
                    fetch(`${API_URL}/events/${currentEvent}/staff-assignments`, { headers: { "Authorization": `Bearer ${token}` } })
                ]);

                const staffData = await staffRes.json();
                allStaff = Array.isArray(staffData) ? staffData : [];
                allBuvettes = await buvettesRes.json();
                assignments = (await assignmentsRes.json()) || [];

                render();
            } catch (err) {
                console.error(err);
                showToast("Erreur de chargement", "error");
            }
        }

        function render() {
            renderStaffPool();
            renderBuvettes();
        }

        function renderStaffPool() {
            const pool = document.getElementById("staff-pool");
            const assignedIds = assignments.map(a => Number(a.staffId));

            if (allStaff.length === 0) {
                pool.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 20px;">Aucun membre du staff</div>';
                return;
            }

            pool.innerHTML = allStaff.map(s => {
                const isAssigned = assignedIds.includes(Number(s.id));
                return `
                <div class="staff-card ${isAssigned ? 'assigned' : ''}" 
                     ${isAssigned ? '' : 'draggable="true"'} 
                     data-id="${s.id}" 
                     ${isAssigned ? '' : 'ondragstart="handleDragStart(event)" ondragend="handleDragEnd(event)"'}>
                    <div class="staff-info">
                        <div class="name">${s.firstName} ${s.lastName}</div>
                        <div class="type">${isAssigned ? '✓ Assigné' : (s.staffType || 'EXTRA')}</div>
                    </div>
                    <span class="badge ${isAssigned ? 'badge-success' : 'badge-primary'}">${s.staffType || 'EXTRA'}</span>
                </div>
            `}).join('');
        }

        function renderBuvettes() {
            const grid = document.getElementById("buvettes-grid");

            if (allBuvettes.length === 0) {
                grid.innerHTML = '<div class="empty-grid">Aucune buvette active pour cet événement</div>';
                return;
            }

            console.log("Rendering buvettes. Assignments:", assignments);
            console.log("All staff:", allStaff);

            grid.innerHTML = allBuvettes.map(b => {
                const buvette = b.buvette || b;
                const buvetteAssignments = assignments.filter(a => Number(a.buvetteId) === Number(buvette.id));

                console.log(`Buvette ${buvette.name} (id:${buvette.id}):`, buvetteAssignments.length, "assignments");

                return `
                    <div class="buvette-card">
                        <div class="buvette-header">
                            <span class="buvette-name">${buvette.name}</span>
                            <span class="staff-count">${buvetteAssignments.length} staff</span>
                        </div>
                        <div class="buvette-body" 
                             ondragover="handleDragOver(event)" 
                             ondragleave="handleDragLeave(event)" 
                             ondrop="handleDrop(event, ${buvette.id})">
                            ${buvetteAssignments.length === 0 ? `
                                <div class="empty-buvette">
                                    <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                                        <circle cx="9" cy="7" r="4"/>
                                        <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                    </svg>
                                    <p>Glissez du staff ici</p>
                                </div>
                            ` : buvetteAssignments.map(a => {
                    // Use staff from assignment (included via Prisma)
                    const staff = a.staff || allStaff.find(s => Number(s.id) === Number(a.staffId));
                    if (!staff) return `<div class="staff-card"><div class="staff-info"><div class="name">Staff #${a.staffId}</div><div class="type">Non trouvé</div></div></div>`;
                    const arrivalTime = a.arrivalTime || '—';
                    return `
                                    <div class="staff-card">
                                        <div class="staff-info">
                                            <div class="name">${staff.firstName} ${staff.lastName}</div>
                                            <div class="type">${staff.staffType || 'EXTRA'}</div>
                                        </div>
                                        <span class="arrival-time editable" onclick="editArrivalTime(${buvette.id}, ${a.staffId}, '${arrivalTime}')" title="Cliquer pour modifier">${arrivalTime}</span>
                                        <span class="remove-btn" onclick="removeStaff(${buvette.id}, ${a.staffId})">×</span>
                                    </div>
                                `;
                }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterStaff(query) {
            const term = query.toLowerCase();
            const cards = document.querySelectorAll("#staff-pool .staff-card");
            cards.forEach(card => {
                const text = card.innerText.toLowerCase();
                card.style.display = text.includes(term) ? "flex" : "none";
            });
        }

        // --- API Actions ---
        async function assignStaff(buvetteId, staffId) {
            try {
                const res = await fetch(`${API_URL}/events/${currentEvent}/buvettes/${buvetteId}/staff`, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ staffId })
                });
                if (!res.ok) throw new Error();
                loadData();
                showToast("Staff assigné", "success");
            } catch (err) {
                showToast("Erreur lors de l'assignation", "error");
            }
        }

        async function removeStaff(buvetteId, staffId) {
            showConfirm("Retirer ce membre ?", async () => {
                try {
                    await fetch(`${API_URL}/events/${currentEvent}/buvettes/${buvetteId}/staff/${staffId}`, {
                        method: "DELETE",
                        headers: { "Authorization": `Bearer ${token}` }
                    });
                    loadData();
                    showToast("Staff retiré", "success");
                } catch (err) {
                    showToast("Erreur lors de la suppression", "error");
                }
            });
        }

        async function editArrivalTime(buvetteId, staffId, currentTime) {
            const newTime = prompt("Modifier l'heure d'arrivée (format HH:MM):", currentTime !== '—' ? currentTime : '17:30');
            if (!newTime || newTime === currentTime) return;

            // Validate time format
            if (!/^\d{2}:\d{2}$/.test(newTime)) {
                showToast("Format invalide. Utilisez HH:MM", "error");
                return;
            }

            try {
                const res = await fetch(`${API_URL}/events/${currentEvent}/buvettes/${buvetteId}/staff/${staffId}`, {
                    method: "PATCH",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ arrivalTime: newTime })
                });
                if (!res.ok) throw new Error();
                loadData();
                showToast("Heure modifiée", "success");
            } catch (err) {
                showToast("Erreur lors de la modification", "error");
            }
        }

        document.addEventListener("DOMContentLoaded", loadEvents);
    </script>
</body>

</html>