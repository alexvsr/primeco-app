<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuration Inventaire - Admin | Prime&Co</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="shared.css">
    <!-- SortableJS for Drag and Drop -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --primary: #d62839;
            --primary-dark: #96151c;
            --accent: #6366f1;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text: #1f2937;
            --text-secondary: #6b7280;
            --text-muted: #9ca3af;
            --bg-light: #f8fafc;
            --border: rgba(0, 0, 0, 0.06);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            margin: 0;
            background: linear-gradient(145deg, #f0f4f8 0%, #e2e8f0 50%, #cbd5e1 100%);
        }

        /* Animated background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 80%, rgba(214, 40, 57, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(99, 102, 241, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        /* Topbar */
        .topbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 16px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 16px;
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--text);
        }

        .brand-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 20px rgba(214, 40, 57, 0.3);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .brand-icon:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 25px rgba(214, 40, 57, 0.4);
        }

        .brand-icon svg {
            width: 22px;
            height: 22px;
            fill: white;
        }

        .back-link {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            padding: 12px 18px;
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.02);
            transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .back-link:hover {
            background: linear-gradient(135deg, rgba(214, 40, 57, 0.1) 0%, rgba(150, 21, 28, 0.1) 100%);
            color: var(--primary);
            transform: translateX(-4px);
        }

        /* Layout */
        .workspace {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
            z-index: 1;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.03);
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(to bottom, rgba(255, 255, 255, 1), rgba(248, 250, 252, 0.95));
        }

        .sidebar-title {
            font-weight: 700;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sidebar-title svg {
            width: 16px;
            height: 16px;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 12px 16px 12px 42px;
            border-radius: 12px;
            border: 1px solid rgba(0, 0, 0, 0.08);
            background: white;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(214, 40, 57, 0.1);
        }

        .search-box svg {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            color: var(--text-muted);
        }

        .buvette-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .buvette-list::-webkit-scrollbar {
            width: 6px;
        }

        .buvette-list::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        .buvette-item {
            padding: 16px;
            border-radius: 14px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
            margin-bottom: 8px;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.02);
        }

        .buvette-item:hover {
            transform: translateX(4px);
            border-color: rgba(214, 40, 57, 0.15);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
        }

        .buvette-item.active {
            background: linear-gradient(135deg, rgba(214, 40, 57, 0.08) 0%, rgba(150, 21, 28, 0.05) 100%);
            border-color: var(--primary);
            box-shadow: 0 4px 20px rgba(214, 40, 57, 0.15);
        }

        .buvette-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text);
        }

        .buvette-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 4px;
        }

        .buvette-badge {
            background: linear-gradient(135deg, var(--accent), #818cf8);
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 6px;
            margin-left: auto;
        }

        /* Main Area */
        .main-area {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            display: flex;
            gap: 24px;
        }

        .column {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid var(--border);
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.04);
            transition: all 0.3s;
        }

        .column:hover {
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.06);
        }

        .column-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(to bottom, white, var(--bg-light));
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .column-title {
            font-weight: 700;
            font-size: 1rem;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .column-title svg {
            width: 22px;
            height: 22px;
            color: var(--primary);
        }

        .column-count {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
        }

        .column-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: linear-gradient(to bottom, var(--bg-light), #f1f5f9);
        }

        /* Product Cards */
        .product-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 100px;
        }

        .product-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 14px 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.02);
        }

        .product-card:hover {
            border-color: rgba(214, 40, 57, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
        }

        .product-card-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .product-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .product-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text);
        }

        .product-unit {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Stock Input */
        .stock-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 10px;
        }

        .stock-label {
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .stock-input {
            width: 80px;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            text-align: center;
            font-size: 0.9rem;
            font-weight: 600;
            background: white;
            transition: all 0.3s;
        }

        .stock-input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(214, 40, 57, 0.1);
        }

        .stock-unit {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-left: auto;
        }

        /* Action Buttons */
        .btn-action {
            width: 34px;
            height: 34px;
            border-radius: 10px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .btn-add {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1));
            color: var(--success);
        }

        .btn-add:hover {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-remove {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.1));
            color: var(--danger);
        }

        .btn-remove:hover {
            background: linear-gradient(135deg, var(--danger), #dc2626);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .btn-action svg {
            width: 18px;
            height: 18px;
            stroke-width: 2.5;
        }

        /* Category Groups */
        .category-group {
            margin-bottom: 20px;
        }

        .category-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            font-weight: 700;
            margin-bottom: 10px;
            padding-left: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .category-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(to right, var(--border), transparent);
        }

        /* Empty State */
        .empty-main {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
            text-align: center;
        }

        .empty-icon {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, white, var(--bg-light));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.06);
            border: 1px solid var(--border);
            animation: pulse 3s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        .empty-icon svg {
            width: 50px;
            height: 50px;
            stroke: var(--text-muted);
        }

        .empty-main h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text);
            margin: 0 0 8px 0;
        }

        .empty-main p {
            color: var(--text-muted);
            margin: 0;
        }

        /* Config Panel */
        #config-panel {
            display: none;
            width: 100%;
            height: 100%;
        }

        #config-panel.active {
            display: flex;
            gap: 24px;
        }

        /* Drag and Drop */
        .ghost-card {
            background: linear-gradient(135deg, rgba(214, 40, 57, 0.08) 0%, rgba(150, 21, 28, 0.05) 100%);
            border: 2px dashed rgba(214, 40, 57, 0.3);
            opacity: 0.6;
        }

        .sortable-drag {
            opacity: 0;
        }

        .assigned-list .product-card {
            cursor: grab;
        }

        .assigned-list .product-card:active {
            cursor: grabbing;
        }

        /* Save Banner */
        .save-banner {
            position: fixed;
            bottom: 32px;
            left: 50%;
            transform: translateX(-50%) translateY(150%);
            background: linear-gradient(135deg, #1f2937, #111827);
            color: white;
            padding: 16px 28px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.3);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 1000;
        }

        .save-banner.show {
            transform: translateX(-50%) translateY(0);
        }

        .save-banner span {
            font-weight: 600;
        }

        .save-banner button {
            background: var(--primary);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .save-banner button:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        /* Search in column */
        .column-search {
            margin-bottom: 16px;
            position: relative;
        }

        .column-search input {
            width: 100%;
            padding: 12px 16px 12px 42px;
            border-radius: 12px;
            border: 1px solid rgba(0, 0, 0, 0.08);
            font-size: 0.9rem;
            background: white;
            transition: all 0.3s;
        }

        .column-search input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(214, 40, 57, 0.1);
        }

        .column-search svg {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            color: var(--text-muted);
        }

        /* Catalog product card (simpler) */
        .catalog-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
            margin-bottom: 8px;
        }

        .catalog-card:hover {
            border-color: rgba(16, 185, 129, 0.3);
            background: rgba(16, 185, 129, 0.02);
        }
    </style>
</head>

<body>
    <div class="topbar">
        <div class="brand">
            <div class="brand-icon">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
                </svg>
            </div>
            <span>Configuration Inventaire</span>
        </div>
        <a href="admin.html" class="back-link">
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke="currentColor" width="18" height="18">
                <path d="m15 18-6-6 6-6" />
            </svg>
            Retour au dashboard
        </a>
    </div>

    <div class="workspace">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9h18v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9Z" />
                        <path d="M12 3v6" />
                    </svg>
                    Buvettes
                </div>
                <div class="search-box">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8" />
                        <path d="m21 21-4.3-4.3" />
                    </svg>
                    <input type="text" id="buvette-search" placeholder="Rechercher...">
                </div>
            </div>
            <div class="buvette-list" id="buvette-list">
                <!-- Loaded via JS -->
            </div>
        </aside>

        <main class="main-area">
            <div id="empty-state" class="empty-main">
                <div class="empty-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M3 9h18v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9Z" />
                        <path d="M12 3v6" />
                        <path d="M9 13h6" />
                        <path d="M12 13v4" />
                    </svg>
                </div>
                <h3>Sélectionnez une buvette</h3>
                <p>Cliquez sur une buvette pour configurer ses produits et stocks</p>
            </div>

            <div id="config-panel">
                <!-- Assigned Products -->
                <div class="column">
                    <div class="column-header">
                        <div class="column-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 11l3 3L22 4" />
                                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" />
                            </svg>
                            Produits de la buvette
                        </div>
                        <span class="column-count" id="assigned-count">0</span>
                    </div>
                    <div class="column-body">
                        <div id="assigned-list" class="product-list assigned-list"></div>
                    </div>
                </div>

                <!-- Available Products -->
                <div class="column">
                    <div class="column-header">
                        <div class="column-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="m7.5 4.27 9 5.15" />
                                <path
                                    d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z" />
                            </svg>
                            Catalogue
                        </div>
                    </div>
                    <div class="column-body">
                        <div class="column-search">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8" />
                                <path d="m21 21-4.3-4.3" />
                            </svg>
                            <input type="text" id="catalog-search" placeholder="Filtrer le catalogue...">
                        </div>
                        <div id="catalog-list"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="save-banner" class="save-banner">
        <span>Modifications en attente</span>
        <button onclick="saveOrder()">Enregistrer l'ordre</button>
    </div>

    <script src="config.js"></script>
    <script src="shared.js"></script>

    <script>
        const token = localStorage.getItem("access_token");
        let currentBuvetteId = null;
        let currentBuvetteName = '';
        let allProducts = [];
        let assignedProducts = [];
        let sortable = null;
        let stockDebounceTimers = {};

        // Init
        document.addEventListener('DOMContentLoaded', async () => {
            if (!token) window.location.href = 'index.html';
            await Promise.all([loadBuvettes(), loadGlobalProducts()]);

            // Search filter for buvettes
            document.getElementById('buvette-search').addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                document.querySelectorAll('.buvette-item').forEach(item => {
                    item.style.display = item.innerText.toLowerCase().includes(term) ? 'block' : 'none';
                });
            });

            // Search filter for catalog
            document.getElementById('catalog-search').addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                document.querySelectorAll('.catalog-card').forEach(item => {
                    const match = item.dataset.search.includes(term);
                    item.style.display = match ? 'flex' : 'none';
                });
                document.querySelectorAll('.category-group').forEach(group => {
                    const hasVisible = Array.from(group.querySelectorAll('.catalog-card')).some(el => el.style.display !== 'none');
                    group.style.display = hasVisible ? 'block' : 'none';
                });
            });
        });

        // Load Buvettes
        async function loadBuvettes() {
            try {
                const res = await fetch(`${API_URL}/buvettes`, { headers: { "Authorization": `Bearer ${token}` } });
                const buvettes = await res.json();
                renderBuvettes(buvettes);
            } catch (e) {
                console.error(e);
                showToast('Erreur chargement des buvettes', 'error');
            }
        }

        function renderBuvettes(list) {
            const container = document.getElementById('buvette-list');
            container.innerHTML = list.map(b => `
                <div class="buvette-item" data-id="${b.id}" onclick="selectBuvette(${b.id}, '${b.name.replace(/'/g, "\\'")}', this)">
                    <div class="buvette-name">${b.name}</div>
                    <div class="buvette-meta">
                        <span>${b.sport}</span>
                        <span class="buvette-badge">${b.locationType || 'Standard'}</span>
                    </div>
                </div>
            `).join('');
        }

        // Load Products
        async function loadGlobalProducts() {
            try {
                const res = await fetch(`${API_URL}/products`, { headers: { "Authorization": `Bearer ${token}` } });
                allProducts = await res.json();
            } catch (e) {
                console.error(e);
                showToast('Erreur chargement des produits', 'error');
            }
        }

        // Select Buvette
        async function selectBuvette(id, name, el) {
            currentBuvetteId = id;
            currentBuvetteName = name;

            document.querySelectorAll('.buvette-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');

            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('config-panel').classList.add('active');

            await loadAssignedProducts();
        }

        // Load Assigned Products
        async function loadAssignedProducts() {
            try {
                const res = await fetch(`${API_URL}/buvettes/${currentBuvetteId}/products`, {
                    headers: { "Authorization": `Bearer ${token}` }
                });
                const data = await res.json();
                assignedProducts = data.sort((a, b) => (a.displayOrder || 0) - (b.displayOrder || 0));
                renderLists();
                initSortable();
            } catch (e) {
                console.error(e);
                showToast('Erreur chargement des produits', 'error');
            }
        }

        function renderLists() {
            const assignedIds = new Set(assignedProducts.map(p => p.productId));
            const available = allProducts.filter(p => !assignedIds.has(p.id));

            // Render Assigned
            const assignedContainer = document.getElementById('assigned-list');
            assignedContainer.innerHTML = '';

            if (assignedProducts.length === 0) {
                assignedContainer.innerHTML = `
                    <div style="padding: 40px 20px; text-align: center; color: var(--text-muted);">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width: 48px; height: 48px; margin-bottom: 12px; opacity: 0.4;">
                            <path d="M3 9h18v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9Z" />
                            <path d="M9 13h6" />
                        </svg>
                        <p style="margin: 0; font-weight: 500;">Aucun produit assigné</p>
                        <p style="margin: 8px 0 0; font-size: 0.85rem;">Ajoutez des produits depuis le catalogue →</p>
                    </div>
                `;
            } else {
                assignedProducts.forEach(item => {
                    const p = item.product;
                    const defaultStock = item.defaultStock ?? '';

                    assignedContainer.innerHTML += `
                        <div class="product-card" data-product-id="${p.id}">
                            <div class="product-card-row">
                                <div class="product-info">
                                    <span class="product-name">${p.name}</span>
                                    <span class="product-unit">${p.category || 'Divers'} · ${p.unit || 'unité'}</span>
                                </div>
                                <button class="btn-action btn-remove" onclick="removeProduct(${p.id})">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                </button>
                            </div>
                            <div class="stock-row">
                                <span class="stock-label">Stock par défaut :</span>
                                <input type="number" 
                                       class="stock-input" 
                                       id="stock-${p.id}"
                                       value="${defaultStock}" 
                                       placeholder="0"
                                       min="0"
                                       onchange="updateDefaultStock(${p.id}, this.value)">
                                <span class="stock-unit">${p.unit || 'unités'}</span>
                            </div>
                        </div>
                    `;
                });
            }
            document.getElementById('assigned-count').textContent = assignedProducts.length;

            // Render Available (Grouped by category)
            const catalogContainer = document.getElementById('catalog-list');
            catalogContainer.innerHTML = '';

            const grouped = available.reduce((acc, p) => {
                const cat = p.category || 'Divers';
                if (!acc[cat]) acc[cat] = [];
                acc[cat].push(p);
                return acc;
            }, {});

            Object.keys(grouped).sort().forEach(cat => {
                const group = document.createElement('div');
                group.className = 'category-group';
                group.innerHTML = `<div class="category-title">${cat}</div>`;

                grouped[cat].forEach(p => {
                    group.innerHTML += `
                        <div class="catalog-card" data-search="${p.name.toLowerCase()}">
                            <div class="product-info">
                                <span class="product-name">${p.name}</span>
                                <span class="product-unit">${p.unit || 'unité'}</span>
                            </div>
                            <button class="btn-action btn-add" onclick="addProduct(${p.id})">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            </button>
                        </div>
                    `;
                });
                catalogContainer.appendChild(group);
            });
        }

        // Update default stock with debounce
        async function updateDefaultStock(productId, value) {
            // Clear previous timer for this product
            if (stockDebounceTimers[productId]) {
                clearTimeout(stockDebounceTimers[productId]);
            }

            // Set new timer
            stockDebounceTimers[productId] = setTimeout(async () => {
                const defaultStock = value === '' ? null : parseFloat(value);

                try {
                    const item = assignedProducts.find(p => p.productId === productId);
                    await fetch(`${API_URL}/buvettes/${currentBuvetteId}/products`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            productId,
                            displayOrder: item?.displayOrder || 1,
                            defaultStock
                        })
                    });
                    showToast('Stock mis à jour', 'success');

                    // Update local data
                    const idx = assignedProducts.findIndex(p => p.productId === productId);
                    if (idx !== -1) {
                        assignedProducts[idx].defaultStock = defaultStock;
                    }
                } catch (e) {
                    console.error('Error updating stock:', e);
                    showToast('Erreur lors de la mise à jour', 'error');
                }
            }, 500); // 500ms debounce
        }

        // Add product to buvette
        async function addProduct(productId) {
            try {
                const nextOrder = assignedProducts.length + 1;
                await fetch(`${API_URL}/buvettes/${currentBuvetteId}/products`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ productId, displayOrder: nextOrder })
                });
                showToast('Produit ajouté', 'success');
                await loadAssignedProducts();
            } catch (e) {
                console.error(e);
                showToast('Erreur lors de l\'ajout', 'error');
            }
        }

        // Remove product from buvette
        async function removeProduct(productId) {
            try {
                await fetch(`${API_URL}/buvettes/${currentBuvetteId}/products/${productId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                showToast('Produit retiré', 'success');
                await loadAssignedProducts();
            } catch (e) {
                console.error(e);
                showToast('Erreur lors de la suppression', 'error');
            }
        }

        // Drag and Drop for reordering
        function initSortable() {
            const el = document.getElementById('assigned-list');
            if (sortable) sortable.destroy();

            sortable = Sortable.create(el, {
                animation: 200,
                ghostClass: 'ghost-card',
                dragClass: 'sortable-drag',
                handle: '.product-card-row',
                onEnd: function () {
                    document.getElementById('save-banner').classList.add('show');
                }
            });
        }

        // Save reordered products
        async function saveOrder() {
            const children = Array.from(document.getElementById('assigned-list').querySelectorAll('.product-card'));
            const items = children.map((el, index) => ({
                productId: parseInt(el.dataset.productId),
                displayOrder: index + 1
            }));

            try {
                const res = await fetch(`${API_URL}/buvettes/${currentBuvetteId}/products/reorder`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ items })
                });

                if (res.ok) {
                    document.getElementById('save-banner').classList.remove('show');
                    showToast('Ordre enregistré !', 'success');
                    await loadAssignedProducts();
                } else {
                    throw new Error('Erreur API');
                }
            } catch (e) {
                console.error("Save order failed", e);
                showToast('Erreur lors de la sauvegarde', 'error');
            }
        }
    </script>
</body>

</html>