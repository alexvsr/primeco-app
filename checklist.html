<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checklist pré-événement</title>
    <style>
        :root {
            --bg: #f5f5f7;
            --card: #ffffff;
            --primary: #3b82f6;
            --text: #0f172a;
            --muted: #6b7280;
            --border: #e5e7eb;
            --radius: 14px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            background: var(--bg);
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            color: var(--text);
        }

        .page {
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px 16px 40px;
        }

        .topbar {
            background: #fff;
            border-radius: var(--radius);
            padding: 12px 14px;
            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.06);
            border: 1px solid #eef2f7;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .brand {
            font-weight: 700;
            color: #0f172a;
        }

        .nav-links {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-links a {
            padding: 8px 12px;
            border-radius: 10px;
            color: #0f172a;
            text-decoration: none;
            border: 1px solid transparent;
            font-size: 0.95rem;
        }

        .nav-links a.active {
            background: #e0ecff;
            color: #1d4ed8;
            border-color: #c7ddff;
        }

        .nav-links a.nav-disabled {
            color: #9ca3af;
            pointer-events: none;
            border-color: #eceff3;
            background: #f7f7f8;
        }

        .role-badge {
            margin-left: auto;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 0.85rem;
            background: #eef2ff;
            color: #3730a3;
            border: 1px solid #c7d2fe;
        }

        .logout {
            color: var(--muted);
            text-decoration: none;
            font-size: 0.9rem;
        }

        h1 {
            margin: 6px 0 2px;
            font-size: 1.4rem;
        }

        p.lead {
            margin: 0 0 16px;
            color: var(--muted);
        }

        .card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 14px 16px;
            box-shadow: 0 14px 28px rgba(0, 0, 0, 0.06);
            border: 1px solid #eef2f7;
            margin-bottom: 14px;
        }

        .card h3 {
            margin: 4px 0 10px;
        }

        .item {
            display: grid;
            grid-template-columns: 32px 1fr 220px;
            gap: 10px;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .item:last-child {
            border-bottom: none;
        }

        .item label {
            cursor: pointer;
        }

        .item small {
            color: var(--muted);
        }

        .item input[type="text"] {
            width: 100%;
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .item input[type="text"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.15);
        }

        .status-line {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            margin: 8px 0 4px;
            color: var(--muted);
        }

        .badge {
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 0.85rem;
            border: 1px solid transparent;
        }

        .badge-ok {
            background: #dcfce7;
            color: #166534;
            border-color: #bbf7d0;
        }

        .badge-warn {
            background: #fef3c7;
            color: #92400e;
            border-color: #fde68a;
        }

        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            border: none;
            border-radius: 12px;
            padding: 10px 14px;
            font-size: 0.95rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--primary);
            color: #fff;
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.24);
        }

        .btn-ghost {
            background: #f8fafc;
            color: var(--text);
            border: 1px solid var(--border);
        }

        .footnote {
            color: var(--muted);
            font-size: 0.9rem;
            margin-top: 6px;
        }

        @media (max-width: 760px) {
            .item {
                grid-template-columns: 32px 1fr;
                grid-template-rows: auto auto;
            }

            .item input[type="text"] {
                grid-column: 2;
            }
        }
    </style>
</head>

<body>
    <div class="page">
        <div class="topbar">
            <div class="brand">Prime&Co Ops</div>
            <div class="nav-links">
                <a href="timesheets.html" data-nav="timesheets">Fiche horaire</a>
                <a href="inventory.html" data-nav="inventory">Inventaire</a>
                <a href="checklist.html" data-nav="checklist">Checklist</a>
            </div>
            <div class="role-badge" id="role-badge">Rôle</div>
            <a class="logout" href="index.html">Changer de rôle</a>
        </div>

        <h1>Checklist pré-événement</h1>
        <p class="lead">Basée sur la fiche Autocontrôle : à compléter par le RB avant ouverture, visible et validable
            par le Chef des opérations.</p>

        <div class="status-line">
            <span id="status-badge" class="badge badge-warn">En attente</span>
            <span id="status-text">Complète la checklist puis envoie-la pour validation.</span>
        </div>

        <div class="card">
            <h3>Hygiène & sécurité</h3>
            <div class="item">
                <input type="checkbox" id="i-eau">
                <label for="i-eau"><strong>Point d'eau</strong><br><small>Eau chaude/froide disponible, savon,
                        papier.</small></label>
                <input type="text" placeholder="Commentaire" data-note-for="i-eau">
            </div>
            <div class="item">
                <input type="checkbox" id="i-mains">
                <label for="i-mains"><strong>Lavages mains</strong><br><small>Affichage et gel hydroalcoolique en
                        place.</small></label>
                <input type="text" placeholder="Commentaire" data-note-for="i-mains">
            </div>
            <div class="item">
                <input type="checkbox" id="i-frigo">
                <label for="i-frigo"><strong>Températures frigos</strong><br><small>Frigos < 4°C, congélateurs < -18°C
                            (relevé).</small></label>
                <input type="text" placeholder="Température relevée" data-note-for="i-frigo">
            </div>
            <div class="item">
                <input type="checkbox" id="i-allergenes">
                <label for="i-allergenes"><strong>Allergènes affichés</strong><br><small>Signalétique visible, fiche
                        produits à jour.</small></label>
                <input type="text" placeholder="Commentaire" data-note-for="i-allergenes">
            </div>
        </div>

        <div class="card">
            <h3>Matériel & poste</h3>
            <div class="item">
                <input type="checkbox" id="i-encaissement">
                <label for="i-encaissement"><strong>Caisses / TPE</strong><br><small>Test paiement OK, rouleaux
                        disponibles.</small></label>
                <input type="text" placeholder="Commentaire" data-note-for="i-encaissement">
            </div>
            <div class="item">
                <input type="checkbox" id="i-plonge">
                <label for="i-plonge"><strong>Plonge / Vaisselle</strong><br><small>Évier, produit, gants, torchons
                        propres.</small></label>
                <input type="text" placeholder="Commentaire" data-note-for="i-plonge">
            </div>
            <div class="item">
                <input type="checkbox" id="i-stock">
                <label for="i-stock"><strong>Stocks critiques</strong><br><small>Glace, gobelets, sacs poubelle,
                        serviettes.</small></label>
                <input type="text" placeholder="Complément" data-note-for="i-stock">
            </div>
        </div>

        <div class="card">
            <h3>Validation</h3>
            <div class="actions">
                <button class="btn-ghost" id="btn-save">Enregistrer le brouillon</button>
                <button class="btn-primary" id="btn-send">Envoyer au Chef des opérations</button>
            </div>
            <div class="footnote">Le Chef des opérations consultera cette page pour valider ou demander un correctif.
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        const API_URL = (typeof CONFIG !== 'undefined' && CONFIG.API_URL) ? CONFIG.API_URL : "http://localhost:4000/api";
        const roleParam = new URLSearchParams(window.location.search).get("role") || "rb";
        const allowedNav = {
            rb: ["timesheets", "inventory", "checklist"],
            chef: ["timesheets", "inventory", "checklist"],
            log: ["inventory"]
        };
        const roleLabels = { rb: "Responsable de buvette", chef: "Chef des opérations", log: "Logisticien" };

        function enhanceNav(current) {
            const mode = localStorage.getItem("mode");
            const buvetteName = localStorage.getItem("buvette_name");

            if (mode === "RESPONSABLE") {
                // Lock navigation for Manager
                document.querySelector(".brand").textContent = `Prime&Co Ops · ${buvetteName}`;
                document.querySelector(".logout").href = "responsable.html";
                document.querySelector(".logout").textContent = "Retour au menu";
                document.getElementById("role-badge").textContent = "Responsable";

                // Hide role switcher or irrelevant links if needed
                // For now, we keep the links but they should stay in context
                // Ideally, we might want to restrict them further, but the requirement says "ne pas sortir de sa buvette"
                // The links go to other tools for the SAME buvette, which is fine.

                const links = document.querySelectorAll("[data-nav]");
                links.forEach(link => {
                    // Ensure links don't break the flow (they are just pages)
                    // We might want to append buvette_id if the pages needed it in URL, 
                    // but we are moving to localStorage based context.
                });
                return;
            }

            // Default Admin/Role behavior
            const links = document.querySelectorAll("[data-nav]");
            links.forEach(link => {
                const key = link.dataset.nav;
                const isAllowed = allowedNav[roleParam]?.includes(key);
                if (!isAllowed) {
                    link.classList.add("nav-disabled");
                    link.removeAttribute("href");
                } else {
                    const base = link.getAttribute("href").split("?")[0];
                    link.setAttribute("href", base + "?role=" + roleParam);
                }
                if (key === current) link.classList.add("active");
            });
            const badge = document.getElementById("role-badge");
            if (badge) badge.textContent = roleLabels[roleParam] || "Rôle";
        }

        function computeChecklistStatus() {
            const items = Array.from(document.querySelectorAll(".card .item input[type='checkbox']"));
            const total = items.length;
            const checked = items.filter(i => i.checked).length;
            const badge = document.getElementById("status-badge");
            const text = document.getElementById("status-text");
            if (checked === total) {
                badge.textContent = "Complet";
                badge.className = "badge badge-ok";
                text.textContent = "Checklist complète. Tu peux envoyer au Chef des opérations.";
            } else {
                badge.textContent = "En attente";
                badge.className = "badge badge-warn";
                text.textContent = `${checked}/${total} items complétés.`;
            }
        }

        function getPayload() {
            const items = Array.from(document.querySelectorAll(".card .item input[type='checkbox']"));
            const buvetteId = localStorage.getItem("buvette_id") || 45;
            return {
                standId: buvetteId,
                eventId: 123,
                role: roleParam,
                checklist: items.map(cb => {
                    const id = cb.id;
                    const label = document.querySelector("label[for='" + id + "']")?.innerText || id;
                    const note = document.querySelector(`[data-note-for='${id}']`)?.value || "";
                    return { id, label, done: cb.checked, note };
                })
            };
        }

        // API_URL is already defined at the top of the script
        const EVENT_ID = 1; // Hardcoded for demo
        const TEMPLATE_ID = 1; // Hardcoded for demo

        async function loadChecklist() {
            const token = localStorage.getItem("access_token");
            if (!token) return;

            try {
                const res = await fetch(`${API_URL}/checklists/templates/${TEMPLATE_ID}`, {
                    headers: { "Authorization": `Bearer ${token}` }
                });
                if (!res.ok) throw new Error("Erreur chargement template");
                const template = await res.json();
                renderChecklist(template.items);
            } catch (err) {
                console.error(err);
                alert("Impossible de charger la checklist.");
            }
        }

        function renderChecklist(items) {
            // Sort by orderIndex
            items.sort((a, b) => a.orderIndex - b.orderIndex);

            // Group items into categories if needed, or just list them
            // For simplicity, we'll just put them all in one card for now or try to guess category
            // The current HTML has categories (Hygiène, Matériel). The seed data doesn't have categories.
            // We will render them in a single "General" block or map them if we had categories.
            // To keep it simple and working, let's clear existing cards and render one dynamic card.

            const container = document.querySelector(".page");
            // Remove existing cards (after status line)
            const existingCards = document.querySelectorAll(".card");
            existingCards.forEach(c => c.remove());

            const card = document.createElement("div");
            card.className = "card";
            card.innerHTML = `<h3>Checklist Ouverture</h3>`;

            items.forEach(item => {
                const div = document.createElement("div");
                div.className = "item";
                div.innerHTML = `
                <input type="checkbox" id="i-${item.id}" data-item-id="${item.id}">
                <label for="i-${item.id}"><strong>${item.label}</strong></label>
                <input type="text" placeholder="Commentaire" data-note-for="i-${item.id}">
            `;
                card.appendChild(div);
            });

            // Add validation buttons back
            const validationCard = document.createElement("div");
            validationCard.className = "card";
            validationCard.innerHTML = `
            <h3>Validation</h3>
            <div class="actions">
                <button class="btn-ghost" id="btn-save">Enregistrer le brouillon</button>
                <button class="btn-primary" id="btn-send">Envoyer au Chef des opérations</button>
            </div>
            <div class="footnote">Le Chef des opérations consultera cette page pour valider ou demander un correctif.</div>
        `;

            container.appendChild(card);
            container.appendChild(validationCard);

            // Re-attach events
            document.querySelectorAll("input[type='checkbox']").forEach(cb => {
                cb.addEventListener("change", computeChecklistStatus);
            });
            document.getElementById("btn-save").addEventListener("click", () => submitChecklist(false));
            document.getElementById("btn-send").addEventListener("click", () => submitChecklist(true));

            computeChecklistStatus();
        }

        async function submitChecklist(isFinal) {
            const token = localStorage.getItem("access_token");
            const buvetteId = localStorage.getItem("buvette_id") || 1;

            const items = Array.from(document.querySelectorAll(".item input[type='checkbox']"));
            const payload = {
                items: items.map(cb => ({
                    item_id: parseInt(cb.dataset.itemId),
                    value: cb.checked,
                    comment: document.querySelector(`[data-note-for='${cb.id}']`)?.value || ""
                }))
            };

            try {
                const res = await fetch(`${API_URL}/events/${EVENT_ID}/buvettes/${buvetteId}/checklists/${TEMPLATE_ID}`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.message);
                }

                alert(isFinal ? "Checklist envoyée !" : "Brouillon enregistré.");
                if (isFinal) {
                    // Optionally submit status change if needed, but POST creates it as DRAFT.
                    // We might need a separate call to submit if the API requires it.
                    // The API has /submit endpoint.
                    const data = await res.json();
                    await fetch(`${API_URL}/checklists/responses/${data.id}/submit`, {
                        method: "POST",
                        headers: { "Authorization": `Bearer ${token}` }
                    });
                }
            } catch (err) {
                console.error(err);
                alert("Erreur lors de l'envoi : " + err.message);
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            enhanceNav("checklist");
            loadChecklist();
        });
    </script>
</body>

</html>