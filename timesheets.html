<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiche Horaire – Prime&Co</title>
    <meta name="description" content="Gestion des fiches horaires - Prime&Co Ops">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="shared.css">
    <style>
        /* Grenat bar */
        .grenat-bar {
            height: 4px;
            background: linear-gradient(90deg, #601D2B, #C9A227);
        }

        /* Header */
        .header-bar {
            background: white;
            padding: 12px 24px;
        }

        .brand-logo {
            height: 40px;
        }

        .nav-links {
            display: flex;
            gap: 8px;
        }

        .nav-link {
            padding: 8px 14px;
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.2s;
        }

        .nav-link:hover {
            background: var(--bg-tertiary);
            color: var(--text);
        }

        .nav-link.active {
            background: rgba(96, 29, 43, 0.1);
            color: var(--primary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        /* Context info */
        .context-bar {
            background: linear-gradient(135deg, rgba(96, 29, 43, 0.05), rgba(201, 162, 39, 0.05));
            border-bottom: 1px solid var(--border);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .context-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .context-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-sm);
        }

        .context-icon svg {
            width: 18px;
            height: 18px;
            stroke: var(--primary);
        }

        .context-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .context-value {
            font-weight: 600;
            color: var(--text);
        }

        /* Main content */
        .main-content {
            padding: 32px 24px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text);
        }

        .page-subtitle {
            color: var(--text-muted);
            margin-bottom: 24px;
        }

        /* Staff panel */
        .staff-panel {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            margin-bottom: 24px;
            overflow: hidden;
        }

        .panel-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .panel-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .panel-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .staff-select {
            min-width: 250px;
        }

        /* Table */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th {
            text-align: left;
            padding: 14px 16px;
            background: var(--bg-tertiary);
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
        }

        td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        tr:hover td {
            background: rgba(96, 29, 43, 0.02);
        }

        .staff-name {
            font-weight: 600;
            color: var(--text);
        }

        .staff-type {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* Input styles */
        td input[type="time"],
        td input[type="number"],
        td input[type="text"] {
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-size: 0.9rem;
            width: 100%;
            min-width: 100px;
        }

        td input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(96, 29, 43, 0.1);
        }

        td input[type="number"] {
            width: 80px;
            min-width: 80px;
        }

        .hours-display {
            font-weight: 600;
            color: var(--primary);
            font-size: 1rem;
        }

        /* Checkbox */
        .checkbox-cell {
            text-align: center;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .checkbox-label input {
            display: none;
        }

        .checkbox-custom {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .checkbox-label input:checked+.checkbox-custom {
            background: var(--success);
            border-color: var(--success);
        }

        .checkbox-label input:disabled+.checkbox-custom {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .checkbox-custom svg {
            width: 14px;
            height: 14px;
            stroke: white;
            opacity: 0;
        }

        .checkbox-label input:checked+.checkbox-custom svg {
            opacity: 1;
        }

        /* Empty state */
        .empty-table {
            text-align: center;
            padding: 60px 40px;
            color: var(--text-muted);
        }

        .empty-table-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            background: var(--bg-tertiary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .empty-table-icon svg {
            width: 32px;
            height: 32px;
            stroke: var(--text-muted);
        }

        /* Footer actions */
        .panel-footer {
            padding: 20px 24px;
            background: var(--bg-tertiary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .summary-text {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .summary-text strong {
            color: var(--primary);
        }

        .action-buttons {
            display: flex;
            gap: 12px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .context-bar {
                flex-direction: column;
                align-items: flex-start;
            }

            .panel-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .panel-footer {
                flex-direction: column;
                align-items: stretch;
            }

            .action-buttons {
                flex-direction: column;
            }

            .nav-links {
                display: none;
            }
        }
    </style>
</head>

<body>
    <!-- Grenat bar -->
    <div class="grenat-bar"></div>

    <!-- Header -->
    <header class="header-bar">
        <div class="brand flex items-center gap-3">
            <img src="primeco_branding_2550x1440_logo_1-1500x847.jpg" alt="Prime&Co" class="brand-logo">
            <nav class="nav-links">
                <a href="#" class="nav-link active" id="nav-timesheets">Fiche horaire</a>
                <a href="#" class="nav-link" id="nav-inventory">Inventaire</a>
                <a href="#" class="nav-link" id="nav-checklist">Checklist</a>
            </nav>
        </div>
        <div class="header-right">
            <span class="badge badge-primary" id="role-badge">Responsable</span>
            <a href="#" id="back-link" class="btn btn-ghost" style="padding: 8px 14px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    style="width: 18px; height: 18px;">
                    <path d="m15 18-6-6 6-6" />
                </svg>
                Retour
            </a>
        </div>
    </header>

    <!-- Context bar -->
    <div class="context-bar">
        <div class="context-item">
            <div class="context-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                    <rect width="18" height="18" x="3" y="4" rx="2" />
                    <line x1="16" x2="16" y1="2" y2="6" />
                    <line x1="8" x2="8" y1="2" y2="6" />
                    <line x1="3" x2="21" y1="10" y2="10" />
                </svg>
            </div>
            <div>
                <div class="context-label">Événement</div>
                <div class="context-value" id="event-name">Chargement...</div>
            </div>
        </div>
        <div class="context-item">
            <div class="context-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                    <path d="M3 9h18v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9Z" />
                    <path d="m3 9 2.45-4.9A2 2 0 0 1 7.24 3h9.52a2 2 0 0 1 1.8 1.1L21 9" />
                    <path d="M12 3v6" />
                </svg>
            </div>
            <div>
                <div class="context-label">Buvette</div>
                <div class="context-value" id="buvette-name">Chargement...</div>
            </div>
        </div>
    </div>

    <!-- Main content -->
    <main class="main-content">
        <h1 class="page-title">Fiche Horaire</h1>
        <p class="page-subtitle">Saisissez les heures de travail de l'équipe pour cet événement</p>

        <!-- Staff panel -->
        <div class="staff-panel fade-in">
            <div class="panel-header">
                <h2 class="panel-title">Équipe présente</h2>
                <!-- Manual add removed as per request - auto-loading only -->
            </div>

            <div class="table-container">
                <table id="timesheet-table">
                    <thead>
                        <tr>
                            <th>Membre</th>
                            <th>Poste</th>
                            <th>Arrivée</th>
                            <th>Départ</th>
                            <th>Pause (min)</th>
                            <th>Heures</th>
                            <th>Remarques</th>
                            <th style="text-align: center;">Validé</th>
                        </tr>
                    </thead>
                    <tbody id="timesheet-body">
                        <!-- Rows will be added dynamically -->
                    </tbody>
                </table>

                <div class="empty-table" id="empty-state">
                    <div class="empty-table-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                            <circle cx="12" cy="12" r="10" />
                            <polyline points="12 6 12 12 16 14" />
                        </svg>
                    </div>
                    <p><strong>Aucun membre ajouté</strong></p>
                    <p style="margin-top: 8px;">Sélectionnez un membre du staff et cliquez sur "Ajouter"</p>
                </div>
            </div>

            <div class="panel-footer">
                <div class="summary-text">
                    <span id="summary-count">0</span> membres · <strong id="summary-hours">0.0</strong> heures totales
                </div>
                <div class="action-buttons">
                    <button class="btn btn-ghost" id="btn-save-draft">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            style="width: 18px; height: 18px;">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
                            <polyline points="17 21 17 13 7 13 7 21" />
                            <polyline points="7 3 7 8 15 8" />
                        </svg>
                        Enregistrer brouillon
                    </button>
                    <button class="btn btn-primary" id="btn-submit">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            style="width: 18px; height: 18px;">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                            <polyline points="22 4 12 14.01 9 11.01" />
                        </svg>
                        Soumettre la fiche
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script src="config.js"></script>
    <script src="shared.js"></script>
    <script>
        // Get context from URL params or localStorage
        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('eventId') || localStorage.getItem('event_id');
        const buvetteId = urlParams.get('buvetteId') || localStorage.getItem('buvette_id');
        const mode = localStorage.getItem('mode');
        const eventName = localStorage.getItem('event_name');
        const buvetteName = localStorage.getItem('buvette_name');

        // Check if we have valid context
        if (!eventId || !buvetteId) {
            // Check if admin mode with token
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = 'index.html';
            }
        }

        // Display context
        document.getElementById('event-name').textContent = eventName || `Événement #${eventId}`;
        document.getElementById('buvette-name').textContent = buvetteName || `Buvette #${buvetteId}`;

        // Setup navigation links
        const navParams = `?eventId=${eventId}&buvetteId=${buvetteId}`;
        document.getElementById('nav-timesheets').href = `timesheets.html${navParams}`;
        document.getElementById('nav-inventory').href = `inventory.html${navParams}`;
        document.getElementById('nav-checklist').href = `checklist.html${navParams}`;

        // Back link
        document.getElementById('back-link').href = mode === 'RESPONSABLE' ? 'responsable.html' : 'admin.html';

        // Staff data storage
        let staffList = [];
        let rowIdCounter = 0;

        // Load staff
        async function loadStaff() {
            try {
                console.log(`[Timesheets] Fetching assignments for event ${eventId}...`);
                const res = await fetch(`${API_URL}/events/${eventId}/assignments`);

                // Fetch existing timesheet if any
                const timesheetRes = await fetch(`${API_URL}/events/${eventId}/timesheets?buvetteId=${buvetteId}`);
                const timesheet = timesheetRes.ok ? await timesheetRes.json() : null;
                console.log("[Timesheets] Existing timesheet:", timesheet);

                if (!res.ok) {
                    console.error('Failed to load assignments');
                    return;
                }

                const allAssignments = await res.json();

                // Filter for current buvette
                const buvetteAssignments = allAssignments.filter(a => Number(a.buvetteId) === Number(buvetteId));

                if (buvetteAssignments.length === 0) {
                    showToast(`Aucun staff trouvé pour Buvette #${buvetteId}`, 'warning');
                } else {
                    showToast(`${buvetteAssignments.length} staff trouvés`, 'success');
                }

                // Extract staff details and populate list
                staffList = buvetteAssignments.map(a => {
                    // Check if we have saved data for this staff
                    let savedShift = null;
                    if (timesheet && timesheet.shifts) {
                        savedShift = timesheet.shifts.find(s => s.staffId === a.staff.id);
                    }

                    // Extract times from saved shift or assignment
                    let arrivalTime = a.arrivalTime || "18:00";
                    let departureTime = "";
                    let breakMinutes = 0;
                    let notes = "";
                    let position = "Serveur";

                    if (savedShift) {
                        // date string to HH:MM helper
                        const formatTime = (dateStr) => {
                            if (!dateStr) return "";
                            const d = new Date(dateStr);
                            return d.toLocaleTimeString('fr-CH', { hour: '2-digit', minute: '2-digit' });
                        };
                        arrivalTime = formatTime(savedShift.startTime);
                        departureTime = formatTime(savedShift.endTime);
                        breakMinutes = savedShift.breakMinutes;
                        notes = savedShift.notes || "";
                        position = savedShift.position || "Serveur";
                    }

                    return {
                        ...a.staff,
                        arrivalTime,
                        departureTime,
                        breakMinutes,
                        notes,
                        position
                    };
                });

                // Clear table to ensure we show fresh data (in case of reload)
                const tbody = document.getElementById('timesheet-body');
                tbody.innerHTML = '';

                if (staffList.length > 0) {
                    staffList.forEach(s => {
                        console.log(`[Timesheets] Auto-adding ${s.firstName} ${s.lastName}`, s);
                        addRow(s);
                    });
                    updateEmptyState();
                    updateSummary();
                }

            } catch (err) {
                console.error('Error loading staff:', err);
                showToast('Erreur lors du chargement', 'error');
            }
        }

        function addRow(staff) {
            const tbody = document.getElementById('timesheet-body');
            const rowId = `row-${++rowIdCounter}`;

            const tr = document.createElement('tr');
            tr.id = rowId;
            tr.dataset.staffId = staff.id;

            // Values to populate
            const startTime = staff.arrivalTime || "18:00";
            const endTime = staff.departureTime || "";
            const breakMins = staff.breakMinutes || 0;
            const notes = staff.notes || "";
            const position = staff.position || "Serveur";

            tr.innerHTML = `
                <td>
                    <div class="staff-name">${staff.firstName} ${staff.lastName}</div>
                    <div class="staff-type">${staff.type || 'EXTRA'}</div>
                </td>
                <td>
                    <input type="text" class="input-position" value="${position}" placeholder="Poste...">
                </td>
                <td>
                    <input type="time" class="input-start" value="${startTime}">
                </td>
                <td>
                    <input type="time" class="input-end" value="${endTime}">
                </td>
                <td>
                    <input type="number" class="input-break" value="${breakMins}" min="0" step="5">
                </td>
                <td>
                    <span class="hours-display">0.0h</span>
                </td>
                <td>
                    <input type="text" class="input-notes" value="${notes}" placeholder="Notes...">
                </td>
                <td class="checkbox-cell">
                    <label class="checkbox-label">
                        <input type="checkbox" class="input-validated" disabled>
                        <span class="checkbox-custom">
                            <svg viewBox="0 0 24 24" fill="none" stroke-width="3">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                        </span>
                    </label>
                </td>
            `;

            tbody.appendChild(tr);
            wireRowEvents(tr);
            updateRow(tr);
        }

        function wireRowEvents(row) {
            const inputs = row.querySelectorAll('.input-start, .input-end, .input-break');
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    updateRow(row);
                    updateSummary();
                });
            });
        }

        function updateRow(row) {
            const start = row.querySelector('.input-start').value;
            const end = row.querySelector('.input-end').value;
            const breakMins = parseInt(row.querySelector('.input-break').value) || 0;
            const hoursDisplay = row.querySelector('.hours-display');
            const checkbox = row.querySelector('.input-validated');

            if (start && end) {
                const [sh, sm] = start.split(':').map(Number);
                const [eh, em] = end.split(':').map(Number);
                let mins = (eh * 60 + em) - (sh * 60 + sm) - breakMins;
                if (mins < 0) mins = 0; // Or handle overnight

                // Allow overnight: if end < start, assume +24h
                if (eh < sh || (eh === sh && em < sm)) {
                    mins = ((eh + 24) * 60 + em) - (sh * 60 + sm) - breakMins;
                }

                const hours = (mins / 60).toFixed(1);
                hoursDisplay.textContent = hours + 'h';
                checkbox.disabled = false;
            } else {
                hoursDisplay.textContent = '0.0h';
                checkbox.checked = false;
                checkbox.disabled = true;
            }
        }

        function updateEmptyState() {
            const tbody = document.getElementById('timesheet-body');
            const empty = document.getElementById('empty-state');
            empty.style.display = tbody.children.length === 0 ? 'block' : 'none';
        }

        function updateSummary() {
            const rows = document.querySelectorAll('#timesheet-body tr');
            let totalHours = 0;
            rows.forEach(row => {
                const text = row.querySelector('.hours-display').textContent;
                totalHours += parseFloat(text) || 0;
            });

            document.getElementById('summary-count').textContent = rows.length;
            document.getElementById('summary-hours').textContent = totalHours.toFixed(1);
        }

        // Save draft
        document.getElementById('btn-save-draft').addEventListener('click', () => {
            showToast('Brouillon enregistré', 'success');
        });

        // Submit
        document.getElementById('btn-submit').addEventListener('click', async () => {
            const rows = document.querySelectorAll('#timesheet-body tr');
            if (rows.length === 0) {
                showToast('Aucun membre à soumettre', 'error');
                return;
            }

            const shifts = Array.from(rows).map(tr => {
                const start = tr.querySelector('.input-start').value;
                const end = tr.querySelector('.input-end').value;
                return {
                    staffId: parseInt(tr.dataset.staffId),
                    position: tr.querySelector('.input-position').value,
                    startTime: start,
                    endTime: end,
                    breakMinutes: parseInt(tr.querySelector('.input-break').value) || 0,
                    notes: tr.querySelector('.input-notes').value
                };
            }).filter(s => s.startTime && s.endTime);

            if (shifts.length === 0) {
                showToast('Complétez au moins une ligne avec arrivée et départ', 'error');
                return;
            }

            try {
                const token = localStorage.getItem('access_token');
                const res = await fetch(`${API_URL}/events/${eventId}/timesheets`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                    },
                    body: JSON.stringify({
                        buvetteId: parseInt(buvetteId),
                        shifts
                    })
                });

                if (res.ok) {
                    showToast('Fiche horaire soumise !', 'success');
                } else {
                    const err = await res.json();
                    showToast(err.message || 'Erreur lors de la soumission', 'error');
                }
            } catch (err) {
                console.error(err);
                showToast('Erreur réseau', 'error');
            }
        });

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            loadStaff();
            updateEmptyState();
        });
    </script>
</body>

</html>